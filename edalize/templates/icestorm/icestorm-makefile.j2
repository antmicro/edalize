#Auto generated by Edalize
SHELL = bash

TARGET   := {{ name }}
PCF_FILE := {{ pcf_file }}
PNR      ?= {{ pnr }}
ARACHNE_PNR_OPTIONS := {{ arachne_pnr_options|join(' ') }}
NEXTPNR_OPTIONS     := {{ nextpnr_options|join(' ') }}
DEVICE   := {{ device }}

all: $(TARGET).{{ default_target }}
timing: $(TARGET).tim
stats: $(TARGET).stat

{% if environment_script -%}
SOURCE_OPTS = source {{ environment_script }} &&
{%- endif %}

.PRECIOUS: %_next.asc %_arachne.asc

%.blif: %.mk
	$(MAKE) -f $<
%_arachne.asc: $(PCF_FILE) %.blif
	${SOURCE_OPTS} arachne-pnr $(ARACHNE_PNR_OPTIONS) -q -p $? -o $@
%.json: %.mk
	$(MAKE) -f $<
%_next.asc: %.json
	${SOURCE_OPTS} nextpnr-ice40 -l next.log -q $(NEXTPNR_OPTIONS) --pcf $(PCF_FILE) --json $? --asc $@
%.bin: %_$(PNR).asc
	${SOURCE_OPTS} icepack $< $@
%.tim: %_$(PNR).asc
	${SOURCE_OPTS} icetime -tmd $(DEVICE) $< > $@
%.stat: %_$(PNR).asc
	${SOURCE_OPTS} icebox_stat $< > $@

build-gui: $(TARGET).json
	${SOURCE_OPTS} nextpnr-ice40 -q $(NEXTPNR_OPTIONS) --pcf $(PCF_FILE) --json $? --asc $@ --gui

clean:
	rm -f $(TARGET).blif $(TARGET).json $(TARGET)_arachne.asc $(TARGET)_next.asc $(TARGET).bin
