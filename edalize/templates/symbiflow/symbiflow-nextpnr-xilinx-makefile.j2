#Auto generated by Edalize
SHELL = bash

NAME	:= {{ top }}
PARTNAME:= {{ partname }}
BITSTREAM_DEVICE := {{ bitstream_device }}
BUILDDIR:= {{ builddir }}

{% if fasm2bels %}
RR_GRAPH = {{ rr_graph }}
VPR_GRID = {{ vpr_grid }}
VPR_CAPNP_SCHEMA_DIR = {{ vpr_capnp_schema }}

all: timing_summary.rpt
{% else %}
all: ${NAME}.bit
{% endif %}

{% if environment_script -%}
SOURCE_OPTS = source {{ environment_script }} &&
{%- endif %}

${BUILDDIR}:
	mkdir ${BUILDDIR}

${NAME}.fasm: ${NAME}-nextpnr.mk | ${BUILDDIR}
	${SOURCE_OPTS} $(MAKE) -f ${NAME}-nextpnr.mk

${NAME}.bit: ${NAME}.fasm
	${SOURCE_OPTS} cd ${BUILDDIR} && symbiflow_write_bitstream -d ${BITSTREAM_DEVICE} -f ${NAME}.fasm -p ${PARTNAME} -b ${NAME}.bit

{% if fasm2bels %}
timing_summary.rpt: ${NAME}.bit.v
	bash vivado.sh

${NAME}.bit.v: ${NAME}.bit
	${SOURCE_OPTS} python -m fasm2bels \
		--db_root {{ dbroot }}/${BITSTREAM_DEVICE} \
		--part ${PARTNAME} \
		--bitread bitread \
		--bit_file ${NAME}.bit \
		--fasm_file ${NAME}.bit.fasm \
		--eblif ${NAME}.eblif \
		--connection_database channels.db \
		--rr_graph ${RR_GRAPH} \
		--vpr_grid_map ${VPR_GRID} \
		--vpr_capnp_schema_dir ${VPR_CAPNP_SCHEMA_DIR} \
		--drive 12 \
		--iostandard LVCMOS33 \
		--verilog_file ${NAME}.bit.v \
		--xdc_file ${NAME}.bit.xdc
	rm channels.db

{% endif %}

clean:
	rm -rf ${BUILDDIR}

